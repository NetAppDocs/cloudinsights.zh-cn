---
sidebar: sidebar 
permalink: task_config_telegraf_agent_k8s.html 
keywords: telegraf, installation, install, agent, telegraf agent, kubernetes, eks, operator, k8s 
summary: Cloud Insights 支持 Telegraf 作为其在 Kubernetes 上收集集成数据的代理。 
---
= 配置NetApp Kubernetes监控操作员
:toc: macro
:hardbreaks:
:toclevels: 2
:allow-uri-read: 
:toc: 
:nofooter: 
:toclevels: 2
:icons: font
:linkattrs: 
:imagesdir: ./media/
:toc-position: content


[role="lead"]
Cloud Insights 为Kubernetes收集提供了* NetApp Kubernetes监控操作员*(NKMO）。添加数据收集器时、只需选择"Kubernetes "图块即可。


toc::[]
操作员(NKMO）和数据收集器可从Cloud Insights Docker注册表下载。安装后、NKMOO将管理部署在Kubernetes集群节点中的任何与操作员兼容的收集器以获取数据、包括管理这些收集器的生命周期。在此链之后、将从收集器中获取数据并将其发送到Cloud Insights。



== 安装NetApp Kubernetes监控操作员之前

.前提条件：
* 如果您使用的是自定义或私有Docker存储库、请按照使用自定义或私有Docker存储库一节中的说明进行操作
* Kubernetes 1.20或更高版本支持安装NetApp Kubernetes监控操作员。
* 当Cloud Insights 监控后端存储且Kubernetes与Docker容器运行时结合使用时、Cloud Insights 可以显示NFS和iSCSI的POD到PV到存储映射和指标；其他运行时仅显示NFS。
* 从2022年8月开始、NetApp Kubernetes监控操作员支持Pod安全策略(PSP)。如果您的环境使用PSP、则必须升级到最新的NetApp Kubennetes Monitoring Operator。
* 如果您运行的是OpenShift 4.6或更高版本、则除了确保满足这些前提条件之外、您还必须遵循下面的OpenShift说明。
* 仅在Linux节点上安装监控Cloud Insights 支持监控运行Linux的KubeNet节点、方法是指定一个KubeNet节点选择器、用于在这些平台上查找以下KubeNet标签：


|===


| 平台 | 标签 


| Kubernetes v1.20及更高版本 | Kubernetes 。 io/OS = Linux 


| Rancher + catt.io 作为流程编排 /Kubernetes 平台 | catt.io/OS = Linux 
|===
* 运行ARM64架构的节点不支持NetApp Kubernetes监控操作员及其依赖项(电报、Kube-state-metrics、fluentbit等)。
* 必须提供以下命令：Curl、kubecl。可选安装步骤需要使用Docker命令。为获得最佳结果，请将这些命令添加到路径中。请注意、必须至少为kubect配置对以下Kubernetes对象的访问权限：代理、群集角色、群集角色、群集配置、自定义资源定义、部署、 名区、角色、rolebinbeds、密钥、服务帐户、 和服务。请参见此处、了解具有这些最小的"给予"角色权限的示例.yaml文件。
* 要用于安装NetApp Kubennetes监控操作员的主机必须已配置kubec特 尔、以便与目标K8s集群进行通信、并可通过Internet连接到您的Cloud Insights 环境。
* 如果您在安装期间或操作要监控的K8s集群时使用了代理、请按照配置代理支持一节中的说明进行操作。
* NetApp Kubernetes监控操作员会安装自己的Kube-state-metrics、以避免与任何其他实例发生冲突。为了准确地进行审核和数据报告、强烈建议使用网络时间协议(NTP)或简单网络时间协议(SNTP)同步Agent计算机上的时间。
* 如果要重新部署Operator (即更新或替换Operator)、则无需创建_new_ API令牌；您可以重新使用先前的令牌。
* 另请注意、如果您最近安装了NetApp Kubnetes Monitoring Operator、并且正在使用可续订的API访问令牌、则即将过期的令牌将自动替换为新的/刷新的API访问令牌。




== 请在开始之前记下这些内容

如果您使用运行 <<configuring-proxy-support,代理>>、具有 <<using-a-custom-or-private-docker-repository,自定义存储库>>或正在使用 <<openshift-instructions,OpenShift>>、请仔细阅读以下各节。

如果要从先前安装升级、另请阅读 <<升级,升级>> 信息。



== 配置操作员

在较新版本的运算符中，可以在_AgentConfiguration_自定义资源中配置最常修改的设置。您可以通过编辑_operator-config.yaml文件来在部署操作员之前编辑此资源。此文件包含一些已注释掉的设置示例。请参见列表 link:telegraf_agent_k8s_config_options.html["可用设置"] 对于最新版本的运算符。

您也可以在部署操作员后使用以下命令编辑此资源：

 kubectl -n netapp-monitoring edit AgentConfiguration
要确定您部署的操作员版本是否支持AgentConfiguration、请运行以下命令：

 kubectl get crd agentconfigurations.monitoring.netapp.com
如果您看到“Error from server (NotFound)”消息，则必须先升级操作员，然后才能使用AgentConfiguration。



=== 配置代理支持

要安装NetApp Kubernetes监控操作员、您可以在环境中的两个位置使用代理。这些代理系统可以是相同的、也可以是单独的：

* 在执行安装代码片段(使用"curt")期间需要使用代理将执行该片段的系统连接到Cloud Insights 环境
* 目标Kubernetes集群与Cloud Insights 环境通信所需的代理


如果您对其中一个或两个使用代理、则要安装NetApp Kubornetes操作监控器、必须先确保将代理配置为可以与Cloud Insights环境进行良好的通信。例如、从要安装Operator的服务器/VM中、您需要能够访问Cloud Insights并能够从Cloud Insights下载二进制文件。

对于用于安装NetApp Kubernetes操作监控器的代理、在安装操作员之前、请设置_http_proxy/https_proxy_environment变量。对于某些代理环境、您可能还需要设置_no_proxy environment_变量。

要设置变量、请在您的系统上*在*安装NetApp Kubernetes监控操作员之前*执行以下步骤：

. 为当前用户设置 _https_proxy_ 和 / 或 _http_proxy_ 环境变量：
+
.. 如果要设置的代理没有身份验证(用户名/密码)、请运行以下命令：
+
 export https_proxy=<proxy_server>:<proxy_port>
.. 如果要设置的代理具有身份验证(用户名/密码)、请运行以下命令：
+
 export http_proxy=<proxy_username>:<proxy_password>@<proxy_server>:<proxy_port>




要使Kubernetes集群与Cloud Insights 环境通信所使用的代理、请在阅读完所有这些说明后安装NetApp Kubernetes监控操作员。

在部署NetApp Kubernetes Monitoring Operator之前、请在operator-config.yaml中配置AgentConfiguration的代理部分。

[listing]
----
agent:
  ...
  proxy:
    server: <server for proxy>
    port: <port for proxy>
    username: <username for proxy>
    password: <password for proxy>

    # In the noproxy section, enter a comma-separated list of
    # IP addresses and/or resolvable hostnames that should bypass
    # the proxy
    noproxy: <comma separated list>

    isTelegrafProxyEnabled: true
    isFluentbitProxyEnabled: <true or false> # true if Events Log enabled
    isCollectorsProxyEnabled: <true or false> # true if Network Performance and Map enabled
    isAuProxyEnabled: <true or false> # true if AU enabled
  ...
...
----


=== 使用自定义或专用Docker存储库

默认情况下、NetApp Kubrenetes监控操作员将从Cloud Insights 存储库中提取容器映像。如果您将某个Kubornetes集群用作监控目标、并且该集群配置为仅从自定义或私有Docker存储库或容器注册表中提取容器映像、则必须配置对NetApp Kubornetes监控操作员所需容器的访问权限。

从NetApp Monitoring Operator安装磁贴运行"Image Pull Snippet"。此命令将登录到Cloud Insights 存储库、提取操作员的所有映像依赖关系、然后注销Cloud Insights 存储库。出现提示时、输入提供的存储库临时密码。此命令可下载操作员使用的所有映像、包括可选功能的映像。请参见以下内容、了解这些图像用于哪些功能。

核心操作员功能和Kubornetes监控

* NetApp监控
* Kube-RBAC-代理
* Kube-state-metrics
* 电报
* distroless root用户


事件日志

* 流畅位
* Kubbernetes-event-exporter


网络性能和映射

* CI-net-observer


根据您的企业策略，将操作员 Docker 映像推送到您的私有 / 本地 / 企业 Docker 存储库。确保存储库中这些映像的映像标记和目录路径与Cloud Insights 存储库中的映像一致。

在operator-DEPLOYAML中编辑monitor-operator部署、并修改所有映像引用以使用私有Docker存储库。

....
image: <docker repo of the enterprise/corp docker repo>/kube-rbac-proxy:<kube-rbac-proxy version>
image: <docker repo of the enterprise/corp docker repo>/netapp-monitoring:<version>
....
编辑operator-config.yaml中的AgentConfiguration以反映新的Docker repo位置。为私有存储库创建新的imagePullSecret,有关更多详细信息，请参见_https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/_

[listing]
----
agent:
  ...
  # An optional docker registry where you want docker images to be pulled from as compared to CI's docker registry
  # Please see documentation link here: https://docs.netapp.com/us-en/cloudinsights/task_config_telegraf_agent_k8s.html#using-a-custom-or-private-docker-repository
  dockerRepo: your.docker.repo/long/path/to/test
  # Optional: A docker image pull secret that maybe needed for your private docker registry
  dockerImagePullSecret: docker-secret-name
----


=== OpenShift 说明

如果您运行的是OpenShift 4.6或更高版本、则必须在_operator-config.yaml中编辑AgentConfiguration以启用_run特权_设置：

....
# Set runPrivileged to true SELinux is enabled on your kubernetes nodes
runPrivileged: true
....
OpenShift可以实施更高的安全级别、从而可能阻止对某些Kubernetes组件的访问。



=== 容差和污物

要正确收集所有节点上的数据、_tendentaf_、_fluent-bit_和_net-oborder-demonSets必须在集群中的每个节点上计划一个POD。操作器已配置为允许某些众所周知的*污染*。如果您在节点上配置了任何自定义污染、从而阻止Pod在每个节点上运行、则可以为这些污染创建一个*容错* link:telegraf_agent_k8s_config_options.html["在_AgentConfiguration_中"]。如果已将自定义污染应用于集群中的所有节点、则还必须向操作员部署添加必要的容错值、以便可以计划和执行操作员POD。

详细了解Kubbernetes link:https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/["损害和公差"]。



=== 权限

如果您正在监控的集群包含自定义资源、而这些资源没有集群资源 link:https://kubernetes.io/docs/reference/access-authn-authz/rbac/#aggregated-clusterroles["要查看的聚合"]，则需要手动授予操作员对这些资源的访问权限，才能使用事件日志对其进行监控。

. 在安装之前或安装之后编辑_operator-additional－permissions．yaml．编辑资源_ClusterRole．<namespace>－additional－permissions
. 使用动词["GET、"Watch、"list"]为所需的每个组和资源创建一个新规则。参见\https://kubernetes.io/docs/reference/access-authn-authz/rbac/
. 将所做的更改应用于集群


注意：如果要删除先前添加的权限、则在重新启动_event-exporter之后、所做的更改才会生效。



== 安装NetApp Kubernetes监控操作员

image:NKMO-Instructions-1.png[""]
image:NKMO-Instructions-2.png[""]

.在 Kubernetes 上安装 NetApp Kubernetes 监控操作员代理的步骤：
. 输入唯一的集群名称和命名空间。如果您是 <<升级,升级>> 在先前的Kubnetes Operator中、请使用相同的集群名称和命名空间。
. 输入这些代码后、您可以将Download Command代码录复制到剪贴板。
. 将此代码片段粘贴到 _bash_ 窗口中并执行。此时将下载Operator安装文件。请注意、此代码片段具有唯一的密钥、有效期为24小时。
. 如果您有自定义或私有存储库、请复制可选的映像提取代码段、将其粘贴到_bash_ shell中并执行该代码段。提取映像后、将其复制到您的私有存储库。请务必保持相同的标记和文件夹结构。更新_operator-DEPRAYAML_中的路径以及_operator-config.yaml_中的Docker存储库设置。
. 如果需要、请查看可用的配置选项、例如代理或专用存储库设置。您可以阅读有关的更多信息 link:telegraf_agent_k8s_config_options.html["配置选项"]。
. 准备好后、请通过复制kubec临时 应用的小程序来部署Operator、然后下载并执行该操作。
. 安装将自动进行。完成后、单击_Next_按钮。
. 安装完成后、单击_Next_按钮。同时、请务必删除或安全地存储_operator-秘密.yaml文件。


了解更多信息 <<configuring-proxy-support,正在配置代理>>。

了解更多信息 <<using-a-custom-or-private-docker-repository,使用自定义/私有Docker存储库>>。

在安装NetApp Kubnetes Monitoring Operator时、默认情况下会启用Kubnetes EMS日志收集。要在安装后禁用此收集、请单击Kubernetes集群详细信息页面顶部的*修改部署*按钮、然后取消选择"日志收集"。

image:K8s_Modify_Deployment_Screen.png["显示\"日志收集\"复选框的\"修改部署\"屏幕"]

此屏幕还会显示当前日志收集状态。以下是可能的状态：

* 已禁用
* enabled
* Enabled (已启用)—正在进行安装
* Enabled (已启用)—脱机
* Enabled (已启用)-联机
* 错误- API密钥权限不足




== 升级

. 备份现有配置：
+
 kubectl --namespace ci-monitoring get cm -o yaml > /tmp/telegraf-configs.yaml
. 保存K8s集群名称、以便在安装K8s基于操作员的监控解决方案 期间使用、以确保数据连续性。
+
如果您不记得CI中K8s集群的名称、可以使用以下命令行从已保存的配置中提取此集群：

+
 cat /tmp/telegraf-configs.yaml | grep kubernetes_cluster | head -2
. 删除基于脚本的监控
+
要卸载 Kubernetes 上基于脚本的代理，请执行以下操作：

+
如果监控命名空间仅用于 Telegraf ：

+
 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
+
 kubectl delete ns ci-monitoring
+
如果除了 Telegraf 之外，监控命名空间还用于其他目的：

+
 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
. <<installing-the-netapp-kubernetes-monitoring-operator,安装>> 当前运算符。请务必使用上述步骤1中记下的相同集群名称。



NOTE: 如果您运行的是先前安装的基于脚本的Kubernetes代理、则必须执行此操作 <<升级,升级>> NetApp Kubernetes监控操作员。



=== 删除已弃用的基于脚本的代理

请注意，这些命令使用的是默认命名空间 "CI-monitoring" 。如果您已设置自己的命名空间，请在这些命令和所有后续命令和文件中替换该命名空间。

要卸载Kubernetes上基于脚本的代理(例如、升级到NetApp Kubernetes监控操作员时)、请执行以下操作：

如果监控命名空间仅用于 Telegraf ：

 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
 kubectl delete ns ci-monitoring
如果除了 Telegraf 之外，监控命名空间还用于其他目的：

 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf


== 调整操作员

您可以通过微调自定义资源的某些变量来调整NetApp Kubernetes监控操作员以获得最佳性能。有关可调整的变量的说明和列表、请参见安装软件包附带的README文件。安装操作员后、请使用以下命令查看自述文件：

 sudo -E -H ./<installation_script_name> --install

NOTE: Cloud Insights 联邦版不提供操作员调整功能

您可以通过微调自定义资源的某些变量来调整NetApp Kubernetes监控操作员以获得最佳性能。  有关可设置的变量、请参见下表。

要修改这些值、请使用以下命令编辑代理CR (将<namespace> 替换为命名空间)：

 kubectl edit agent agent-monitoring-netapp -n <namespace>
CR规范采用以下格式：

[listing]
----
 - name: <plugin-name>
   ...
   substitutions:
   - key: <variable-name>
     value: <desired-value>
     ...
----
标记为"included in default CR"的项将已存在于代理CR中、并可在其相应插件下找到。必须按照包含的默认替换项提供的示例手动添加标记为"no"的项。



=== 与资源相关的变量

请参见 https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/[]	有关Kubernetes资源的信息。

|===


| 变量名称 | 插件名称 | 包含在默认CR中 | 说明 


| ds_cpu_limits_placeholder | 代理 | 是的。 | Kubernetes的电报CPU限制 


| DS_MEM_limits_placeholder | 代理 | 是的。 | 有关电报的Kubernetes Mem限制 


| ds_cpu_request_placeholder | 代理 | 是的。 | Kubernetes对电报的CPU请求 


| DS_MEM_request_placeholder | 代理 | 是的。 | Kubernetes对电报的内存请求 


| rs_cpu_limits_placeholder | 代理 | 是的。 | Kubernetes的电报RS CPU限制。 


| RS_MEM_limits_placeholder | 代理 | 是的。 | 适用于电报RS的Kubernetes Mem限制 


| rs_cpu_request_placeholder | 代理 | 是的。 | Kubernetes针对电报RS的CPU请求 


| rs_mem_request_placeholder | 代理 | 是的。 | Kubernetes对电报RS的内存请求 


| KSM_CPU_request_placeholder： | KSM | 是的。 | Kubernetes CPU请求Kube-state-metrics Deploy 


| KSM_MEM_request_placeholder： | KSM | 是的。 | Kubernetes CPU请求Kube-state-metrics Deploy 
|===


=== 与Telegraf相关的变量

请参见 https://github.com/influxdata/telegraf/blob/master/docs/CONFIGURATION.md#agent[] 有关电报变量的信息。

|===


| 占位符 | 插件名称 | 包含在默认CR中 | 说明 


| collection_interval_placeholder | 代理 | 否 | (设置电报间隔、类型间隔)：在所有插件的输入之间等待的默认时间。有效时间单位为ns、us (或 µs)、ms、s、m、高 


| round_interval_placeholder | 代理 | 否 | (设置craeaf round_interval、类型为布尔值)按间隔倍数收集指标 


| metric_batch_size_placeholder | 代理 | 否 | (设置crainf metric_batch_size、type int)一个输出电报将在一个批处理中写入的最大记录数 


| metric_buffer_limit_placeholder | 代理 | 否 | (设置crafff metric_buffer_limit、键入int)输出电报将缓存的最大记录数、以等待成功写入 


| COLLECTION_抖动 占位符 | 代理 | 否 | (设置craf collection_j抖动、类型间隔)：每个插件将在计划的收集时间与该时间+ collection_j抖动 之间随机等待一段时间、然后再收集输入 


| precy_placeholder | 代理 | 否 | (设置电报精度、类型间隔)：收集的指标将舍入为指定的精度、如果设置为"0"、则精度将按间隔指定的单位进行设置 


| flush_interval_placeholder | 代理 | 否 | (设置crait flush_interval、type interval)：在两次写入输出之间的默认时间。 


| flush_jit_placeholder | 代理 | 否 | (设置craf flush_jits抖动、类型间隔)：在写入输出之前、每个输出将随机等待计划写入时间与该时间+ flush_jits抖动 之间的一段时间 
|===


=== 其他变量

|===


| 占位符 | 插件名称 | 包含在默认CR中 | 说明 


| cURL CMD_placeholder | 代理 | 是的。 | 用于下载各种资源的cURL命令。例如、"ccur"或"cURL -k" 
|===